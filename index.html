<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sign up / Sign in</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/global.css">
</head>

<body>
    <h1 id="signH1">Sign up / Sign in</h1>

    <div id="anon-ui">
        <a id="manual-link" href="#" target="_self"><button id="login-btn">Sign in with GitHub</button></a>
    </div>

    <div id="user-ui">
        <p id="user-info"></p>
        <button id="logout-btn">Sign out</button>
        <a href="/forum"><button>Go to Forum</button></a><br>
        <a href="/account"><button>Account</button></a>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://qfyckizrmqicdmrzbgig.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmeWNraXpybXFpY2RtcnpiZ2lnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjg2OTMsImV4cCI6MjA4MDYwNDY5M30.DlqFtid6PHUB8cgBPWOtmr6fxmLX0YEO3qvJvzX8bFc';

        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/+esm';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const anonUi = document.getElementById('anon-ui');
        const userUi = document.getElementById('user-ui');
        const userInfo = document.getElementById('user-info');
        const manualLink = document.getElementById('manual-link');
        const sign = document.getElementById("signH1");

        function authorizeUrl() {
            const redirect = 'https://forum.qu30.qzz.io' + window.location.pathname;
            return SUPABASE_URL.replace(/\/$/, '') + '/auth/v1/authorize?provider=github&redirect_to=' + encodeURIComponent(redirect);
        }

        manualLink.href = authorizeUrl();

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            showAnonUI();
        });

        function parseHashTokens() {
            const hash = window.location.hash.replace(/^#/, '');
            if (!hash) return null;
            const params = new URLSearchParams(hash);
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            if (!access_token) return null;
            return { access_token, refresh_token };
        }

        async function finishFromHashIfPresent() {
            const tokens = parseHashTokens();
            if (!tokens) return false;
            await supabase.auth.setSession({
                access_token: tokens.access_token,
                refresh_token: tokens.refresh_token
            });
            try { history.replaceState({}, document.title, window.location.pathname); } catch (e) { }
            return true;
        }

        function hasCodeInQuery() {
            const q = new URLSearchParams(window.location.search);
            return q.has('code');
        }

        function showUserUI(user) {
            anonUi.style.display = 'none';
            userUi.style.display = 'block';
            sign.innerHTML = "Welcome, " + user.user_metadata?.full_name + "!"
            userInfo.textContent = `Signed in as ${user.email || user.user_metadata?.full_name || user.id}`;
        }

        function showAnonUI() {
            anonUi.style.display = 'block';
            userUi.style.display = 'none';
            userInfo.textContent = '';
            sign.innerHTML = "Sign up / Sign in"
        }

        (async function init() {
            if (hasCodeInQuery()) {
                showAnonUI();
                return;
            }
            const finished = await finishFromHashIfPresent();
            if (!finished) {
                const { data: { session } } = await supabase.auth.getSession();
                if (session?.user) showUserUI(session.user);
                else showAnonUI();
            } else {
                const { data: { session } } = await supabase.auth.getSession();
                if (session?.user) showUserUI(session.user);
                else showAnonUI();
            }
            supabase.auth.onAuthStateChange((event, session) => {
                if (session?.user) showUserUI(session.user);
                else showAnonUI();
            });
        })();
    </script>
</body>

</html>
